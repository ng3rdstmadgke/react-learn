# 10. Partial Prerendering (PPR)

- https://nextjs.org/docs/app/getting-started/partial-prerendering

PPRとは端的に言えば同じページ内で静的レンダリングの領域と動的レンダリングの領域を組み合わせることができるレンダリングモデルです。  
現在の殆どのWebアプリでは、ページ全体あるいは特定のルートに対して、静的レンダリングと動的レンダリングのどちらかを選択しています。

このアプリを動的コンポーネントと静的コンポーネントに分割すると次のようになります。

![img](img/10_ppr_site.png)

ユーザーがこのサイトに訪問すると

1. ナビゲーションバーを含む静的ルートシェルが概況され、初期読み込みが高速化されます
2. シェルはその他の動的コンテンツが非同期に読み込まれる場所に穴を残します
3. 非同期のホールは並列でストリーミングされるため、ページの全体的な読み込み時間が短縮されます


## PPRによる事前レンダリングの仕組み

PPRは、Reactの Suspense を使用して、アプリケーションの一部を特定の条件（データ読み込み完了など）が満たされるまでレンダリングを遅延させます。

Suspense のフォールバックは、静的コンテンツと共に初期HTMLファイルに埋め込まれます。ビルド時（または再検証時）に静的コンテンツがプリレンダリングされ、静的シェルが生成されます。  
動的コンテンツのレンダリングは、ユーザーがルートをリクエストするまで延期されます。

コンポーネントを Suspense でラップしても、コンポーネント自体が動的になるわけではありません。サスペンスは静的コードと動的コードの境界として機能します。

ダッシュボードルートでPPRを実装する方法を見てみましょう。


## PPRの実装

PPRを利用するにはNext.jsのカナリアリリースが必要です。

```bash
pnpm install next@canary
```

Next.jsでPPRを有効にするには `next.config.ts` にオプションを追加します。

- https://nextjs.org/docs/app/api-reference/config/next-config-js/ppr


`next.config.ts`
```ts
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  experimental: {  // 追加
    ppr: 'incremental'  // incremental を設定すると特定のルートにPPRを設定できるようになります。
  }
};

export default nextConfig;
```


次に、ダッシュボードレイアウトに `experimental_ppr` セグメント設定オプションを追加します：


`/app/dashboard/layout.tsx`
```tsx
import SideNav from '@/app/ui/dashboard/sidenav'

export const experimental_ppr = true;

// ...
```

これで完了です。開発中のアプリケーションでは違いが見られないかもしれませんが、本番環境ではパフォーマンスの向上が実感できるはずです。Next.js はルートの静的部分を事前にレンダリングし、動的な部分はユーザーが要求するまで遅延させます。

部分的事前レンダリングの素晴らしい点は、コードを変更することなく使用できることです。ルートの動的な部分をサスペンスでラップしている限り、Next.jsはルートのどの部分が静的でどの部分が動的であるかを認識します。
